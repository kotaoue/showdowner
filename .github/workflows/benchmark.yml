name: Language Performance Benchmark

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark-go:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: false

    - name: Run Go benchmark
      run: make go

    - name: Upload Go benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: go-benchmark-results
        path: go/benchmark_*.json
        retention-days: 30

  benchmark-php:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'

    - name: Run PHP benchmark
      run: make php

    - name: Upload PHP benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: php-benchmark-results
        path: php/benchmark_*.json
        retention-days: 30

  benchmark-python3:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run Python3 benchmark
      run: make python3

    - name: Upload Python3 benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: python3-benchmark-results
        path: python3/benchmark_*.json
        retention-days: 30

  benchmark-rust:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Run Rust benchmark
      run: make rust

    - name: Upload Rust benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: rust-benchmark-results
        path: rust/benchmark_*.json
        retention-days: 30

  benchmark-javascript:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Run JavaScript benchmark
      run: make javascript

    - name: Upload JavaScript benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: javascript-benchmark-results
        path: javascript/benchmark_*.json
        retention-days: 30

  benchmark-typescript:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install TypeScript dependencies
      run: cd typescript && npm install

    - name: Run TypeScript benchmark
      run: make typescript

    - name: Upload TypeScript benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: typescript-benchmark-results
        path: typescript/benchmark_*.json
        retention-days: 30

  benchmark-java:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Run Java benchmark
      run: make java

    - name: Upload Java benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: java-benchmark-results
        path: java/benchmark_*.json
        retention-days: 30

  benchmark-kotlin:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Run Kotlin benchmark
      run: make kotlin

    - name: Upload Kotlin benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-benchmark-results
        path: kotlin/benchmark_*.json
        retention-days: 30

  benchmark-cpp:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install C++ dependencies
      run: sudo apt-get update && sudo apt-get install -y build-essential cmake

    - name: Run C++ benchmark
      run: make cpp

    - name: Upload C++ benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: cpp-benchmark-results
        path: cpp/benchmark_*.json
        retention-days: 30

  benchmark-ruby:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Run Ruby benchmark
      run: make ruby

    - name: Upload Ruby benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: ruby-benchmark-results
        path: ruby/benchmark_*.json
        retention-days: 30

  benchmark-c:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install C dependencies
      run: sudo apt-get update && sudo apt-get install -y build-essential

    - name: Run C benchmark
      run: make c

    - name: Upload C benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: c-benchmark-results
        path: c/benchmark_*.json
        retention-days: 30

  benchmark-csharp:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    - name: Run C# benchmark
      run: make csharp

    - name: Upload C# benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: csharp-benchmark-results
        path: csharp/benchmark_*.json
        retention-days: 30

  benchmark-swift:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Swift benchmark
      run: make swift

    - name: Upload Swift benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: swift-benchmark-results
        path: swift/benchmark_*.json
        retention-days: 30

  benchmark-dart:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Dart
      uses: dart-lang/setup-dart@v1
      with:
        sdk: '3.0.0'

    - name: Install Dart dependencies
      run: cd dart && dart pub get

    - name: Run Dart benchmark
      run: make dart

    - name: Upload Dart benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: dart-benchmark-results
        path: dart/benchmark_*.json
        retention-days: 30

  benchmark-scala:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Setup SBT
      run: |
        echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list
        echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | sudo tee /etc/apt/sources.list.d/sbt_old.list
        curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | sudo apt-key add
        sudo apt-get update
        sudo apt-get install sbt

    - name: Run Scala benchmark
      run: make scala

    - name: Upload Scala benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: scala-benchmark-results
        path: scala/benchmark_*.json
        retention-days: 30

  benchmark-julia:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Julia
      uses: julia-actions/setup-julia@v2
      with:
        version: '1.9'

    - name: Install Julia dependencies
      run: cd julia && julia --project=. -e "using Pkg; Pkg.instantiate()"

    - name: Run Julia benchmark
      run: make julia

    - name: Upload Julia benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: julia-benchmark-results
        path: julia/benchmark_*.json
        retention-days: 30

  compare-languages:
    runs-on: ubuntu-latest
    needs: [benchmark-go, benchmark-php, benchmark-python3, benchmark-rust, benchmark-javascript, benchmark-typescript, benchmark-java, benchmark-kotlin, benchmark-cpp, benchmark-ruby, benchmark-c, benchmark-csharp, benchmark-swift, benchmark-dart, benchmark-scala, benchmark-julia]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: false

    - name: Download all benchmark results
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Copy benchmark results to their directories
      run: |
        mkdir -p go php python3 rust javascript typescript java kotlin cpp ruby c csharp swift dart scala julia
        mkdir -p cpp/build
        cp artifacts/go-benchmark-results/* go/ 2>/dev/null || true
        cp artifacts/php-benchmark-results/* php/ 2>/dev/null || true
        cp artifacts/python3-benchmark-results/* python3/ 2>/dev/null || true
        cp artifacts/rust-benchmark-results/* rust/ 2>/dev/null || true
        cp artifacts/javascript-benchmark-results/* javascript/ 2>/dev/null || true
        cp artifacts/typescript-benchmark-results/* typescript/ 2>/dev/null || true
        cp artifacts/java-benchmark-results/* java/ 2>/dev/null || true
        cp artifacts/kotlin-benchmark-results/* kotlin/ 2>/dev/null || true
        cp artifacts/cpp-benchmark-results/* cpp/ 2>/dev/null || true
        cp artifacts/ruby-benchmark-results/* ruby/ 2>/dev/null || true
        cp artifacts/c-benchmark-results/* c/ 2>/dev/null || true
        cp artifacts/csharp-benchmark-results/* csharp/ 2>/dev/null || true
        cp artifacts/swift-benchmark-results/* swift/ 2>/dev/null || true
        cp artifacts/dart-benchmark-results/* dart/ 2>/dev/null || true
        cp artifacts/scala-benchmark-results/* scala/ 2>/dev/null || true
        cp artifacts/julia-benchmark-results/* julia/ 2>/dev/null || true

    - name: Run comparison
      run: cd compare && go run .

    - name: Upload comparison results
      uses: actions/upload-artifact@v4
      with:
        name: language-comparison
        path: comparison_*.json
        retention-days: 30